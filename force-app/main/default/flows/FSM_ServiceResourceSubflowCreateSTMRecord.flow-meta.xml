<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>59.0</apiVersion>
    <areMetricsLoggedToDataCloud>false</areMetricsLoggedToDataCloud>
    <decisions>
        <name>Check_for_field_update</name>
        <label>Check for field update</label>
        <locationX>808</locationX>
        <locationY>998</locationY>
        <defaultConnector>
            <targetReference>Update_Existing_STM</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Address_update</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>CheckAddressisupdated</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>WCorBUisUpdated</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_STM</targetReference>
            </connector>
            <label>Address update</label>
        </rules>
        <rules>
            <name>Leaving_Date_Update</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>CheckEndDateisUpdated</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>WCorBUisUpdated</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_STM2</targetReference>
            </connector>
            <label>Leaving Date Update</label>
        </rules>
    </decisions>
    <decisions>
        <description>SFI-1260</description>
        <name>Is_any_non_sequential_changes_found</name>
        <label>Is any non sequential changes found?</label>
        <locationX>742</locationX>
        <locationY>674</locationY>
        <defaultConnector>
            <targetReference>Get_Existing_STM</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>No</defaultConnectorLabel>
        <rules>
            <name>Yes</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_STM_for_Non_sequential_changes</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Copy_2_of_Call_error_log</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <description>SFI-683</description>
        <name>Is_Existing_STM_available</name>
        <label>Is Existing STM available?</label>
        <locationX>1204</locationX>
        <locationY>890</locationY>
        <defaultConnector>
            <targetReference>Create_STM_record_for_new_Joiners</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Not Available</defaultConnectorLabel>
        <rules>
            <name>Yes_Available</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_Existing_STM</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Check_for_field_update</targetReference>
            </connector>
            <label>Yes Available</label>
        </rules>
    </decisions>
    <decisions>
        <name>Service_Territory_check</name>
        <label>Service Territory check</label>
        <locationX>423</locationX>
        <locationY>458</locationY>
        <defaultConnector>
            <targetReference>Get_STM_for_Non_sequential_changes</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Territory_is_not_there</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_stm_teritorry</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Copy_1_of_Call_error_log</targetReference>
            </connector>
            <label>Territory is not there</label>
        </rules>
    </decisions>
    <decisions>
        <description>Updated SFI-683</description>
        <name>workcentreExternalId_check</name>
        <label>workcentreExternalId check</label>
        <locationX>176</locationX>
        <locationY>134</locationY>
        <defaultConnector>
            <targetReference>Get_stm_teritorry</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Work_Center_or_Start_Date_Missing</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>ServiceResourceRecord.FSM_WorkCentreExternalId__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>EffectiveStartDate</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Copy_1_of_Call_error_log</targetReference>
            </connector>
            <label>Work Center or Start Date Missing</label>
        </rules>
    </decisions>
    <description>Created as part of SFI-701 to create new STM record based on Service resource joining date
Updated As part of SFI-683
Updated as part of SFI-1260
Updated as part of SFL-1179</description>
    <environments>Default</environments>
    <formulas>
        <description>SFI-683</description>
        <name>EffectiveEndDateFormula</name>
        <dataType>DateTime</dataType>
        <expression>{!EffectiveStartDate} - (1/24)</expression>
    </formulas>
    <formulas>
        <name>EffectiveEndDateFormulaUpdate</name>
        <dataType>DateTime</dataType>
        <expression>{!EffectiveEndDateFormula} + (59/1440)</expression>
    </formulas>
    <formulas>
        <name>EffectiveLeavindDateFormula</name>
        <dataType>DateTime</dataType>
        <expression>{!EffectiveLeavingDate} + (59/1440)</expression>
    </formulas>
    <formulas>
        <name>EffectiveLeavingDate</name>
        <dataType>DateTime</dataType>
        <expression>{!EffectiveEndDate} + (23/24)</expression>
    </formulas>
    <interviewLabel>New Joiner STM SubFlow {!$Flow.CurrentDateTime}</interviewLabel>
    <label>FSM Service Resource Subflow Create STM Record</label>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordCreates>
        <name>Create_STM_record_for_new_Joiners</name>
        <label>Create STM record for new Joiners</label>
        <locationX>1204</locationX>
        <locationY>1490</locationY>
        <faultConnector>
            <targetReference>Call_error_log</targetReference>
        </faultConnector>
        <inputAssignments>
            <field>City</field>
            <value>
                <elementReference>City</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Country</field>
            <value>
                <elementReference>Country</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>EffectiveStartDate</field>
            <value>
                <elementReference>EffectiveStartDate</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>OperatingHoursId</field>
            <value>
                <elementReference>Get_Operating_hours.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>PostalCode</field>
            <value>
                <elementReference>PostCode</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>ServiceResourceId</field>
            <value>
                <elementReference>ServiceResourceRecord.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>ServiceTerritoryId</field>
            <value>
                <elementReference>Get_stm_teritorry.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>State</field>
            <value>
                <elementReference>State</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Street</field>
            <value>
                <elementReference>Street</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>TerritoryType</field>
            <value>
                <stringValue>P</stringValue>
            </value>
        </inputAssignments>
        <object>ServiceTerritoryMember</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordCreates>
    <recordLookups>
        <description>SFI-683</description>
        <name>Get_Existing_STM</name>
        <label>Get Existing STM</label>
        <locationX>1204</locationX>
        <locationY>782</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Is_Existing_STM_available</targetReference>
        </connector>
        <filterLogic>1 AND 2 AND (3 OR 4)</filterLogic>
        <filters>
            <field>ServiceResourceId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>ServiceResourceRecord.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>TerritoryType</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>P</stringValue>
            </value>
        </filters>
        <filters>
            <field>EffectiveEndDate</field>
            <operator>IsNull</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <filters>
            <field>EffectiveEndDate</field>
            <operator>GreaterThanOrEqualTo</operator>
            <value>
                <elementReference>EffectiveStartDate</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>ServiceTerritoryMember</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <description>SFI-701, to populate default operating hours</description>
        <name>Get_Operating_hours</name>
        <label>Get Operating hours</label>
        <locationX>423</locationX>
        <locationY>350</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Service_Territory_check</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Name</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Standard Operating Hours (Blank)</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>OperatingHours</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <description>SFI-1260</description>
        <name>Get_STM_for_Non_sequential_changes</name>
        <label>Get STM for Non sequential changes</label>
        <locationX>742</locationX>
        <locationY>566</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Is_any_non_sequential_changes_found</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>ServiceResourceId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>ServiceResourceRecord.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>TerritoryType</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>P</stringValue>
            </value>
        </filters>
        <filters>
            <field>EffectiveStartDate</field>
            <operator>GreaterThan</operator>
            <value>
                <elementReference>EffectiveStartDate</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>ServiceTerritoryMember</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_stm_teritorry</name>
        <label>Get stm territory</label>
        <locationX>423</locationX>
        <locationY>242</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Get_Operating_hours</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>FSM_ExternalId__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>ServiceResourceRecord.FSM_WorkCentreExternalId__c</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>ServiceTerritory</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordUpdates>
        <description>SFI-683</description>
        <name>Update_Existing_STM</name>
        <label>Update Existing STM</label>
        <locationX>1072</locationX>
        <locationY>1106</locationY>
        <connector>
            <targetReference>Create_STM_record_for_new_Joiners</targetReference>
        </connector>
        <faultConnector>
            <isGoTo>true</isGoTo>
            <targetReference>Call_error_log</targetReference>
        </faultConnector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Get_Existing_STM.Id</elementReference>
            </value>
        </filters>
        <inputAssignments>
            <field>EffectiveEndDate</field>
            <value>
                <elementReference>EffectiveEndDateFormulaUpdate</elementReference>
            </value>
        </inputAssignments>
        <object>ServiceTerritoryMember</object>
    </recordUpdates>
    <recordUpdates>
        <name>Update_STM</name>
        <label>Update STM</label>
        <locationX>544</locationX>
        <locationY>1106</locationY>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Get_Existing_STM.Id</elementReference>
            </value>
        </filters>
        <inputAssignments>
            <field>City</field>
            <value>
                <elementReference>City</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Country</field>
            <value>
                <elementReference>Country</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>PostalCode</field>
            <value>
                <elementReference>PostCode</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>State</field>
            <value>
                <elementReference>State</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Street</field>
            <value>
                <elementReference>Street</elementReference>
            </value>
        </inputAssignments>
        <object>ServiceTerritoryMember</object>
    </recordUpdates>
    <recordUpdates>
        <name>Update_STM2</name>
        <label>Update STM</label>
        <locationX>808</locationX>
        <locationY>1106</locationY>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Get_Existing_STM.Id</elementReference>
            </value>
        </filters>
        <inputAssignments>
            <field>EffectiveEndDate</field>
            <value>
                <elementReference>EffectiveLeavindDateFormula</elementReference>
            </value>
        </inputAssignments>
        <object>ServiceTerritoryMember</object>
    </recordUpdates>
    <start>
        <locationX>50</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>workcentreExternalId_check</targetReference>
        </connector>
    </start>
    <status>Active</status>
    <subflows>
        <name>Call_error_log</name>
        <label>Call error log</label>
        <locationX>1776</locationX>
        <locationY>1598</locationY>
        <flowName>ErrorLog_Subflow_Create_Record</flowName>
        <inputAssignments>
            <name>FSM_ExceptionalNumber</name>
            <value>
                <elementReference>ServiceResourceRecord.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>FSM_ExternalId</name>
            <value>
                <elementReference>ServiceResourceRecord.FSM_ExternalId__c</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>FSM_FaultMessage</name>
            <value>
                <elementReference>$Flow.FaultMessage</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>FSM_FlowName</name>
            <value>
                <stringValue>FSM Service Resource Subflow Create STM Record  </stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>FSM_Type</name>
            <value>
                <stringValue>Field Service</stringValue>
            </value>
        </inputAssignments>
    </subflows>
    <subflows>
        <name>Copy_1_of_Call_error_log</name>
        <label>Call error log</label>
        <locationX>176</locationX>
        <locationY>2090</locationY>
        <flowName>ErrorLog_Subflow_Create_Record</flowName>
        <inputAssignments>
            <name>Actioned</name>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>FSM_ExceptionalNumber</name>
            <value>
                <elementReference>ServiceResourceRecord.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>FSM_ExternalId</name>
            <value>
                <elementReference>ServiceResourceRecord.FSM_ExternalId__c</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>FSM_FaultMessage</name>
            <value>
                <stringValue>Either Work Center ID is missing or Start Date is missing in Service Resource Record.</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>FSM_FlowName</name>
            <value>
                <stringValue>FSM Service Resource Subflow Create STM Record  </stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>FSM_Type</name>
            <value>
                <stringValue>Field Service</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>Interface</name>
            <value>
                <stringValue>INT009</stringValue>
            </value>
        </inputAssignments>
    </subflows>
    <subflows>
        <description>SFI-1260</description>
        <name>Copy_2_of_Call_error_log</name>
        <label>Call error log</label>
        <locationX>280</locationX>
        <locationY>782</locationY>
        <flowName>ErrorLog_Subflow_Create_Record</flowName>
        <inputAssignments>
            <name>Actioned</name>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>FSM_ExceptionalNumber</name>
            <value>
                <elementReference>ServiceResourceRecord.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>FSM_ExternalId</name>
            <value>
                <elementReference>ServiceResourceRecord.FSM_ExternalId__c</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>FSM_FaultMessage</name>
            <value>
                <elementReference>INT009ErrorMessageNonSeqn</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>FSM_FlowName</name>
            <value>
                <stringValue>FSM Service Resource Subflow Create STM Record  </stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>FSM_Type</name>
            <value>
                <stringValue>Field Service</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>Interface</name>
            <value>
                <stringValue>INT009</stringValue>
            </value>
        </inputAssignments>
    </subflows>
    <textTemplates>
        <description>SFI-1260</description>
        <name>INT009ErrorMessageNonSeqn</name>
        <isViewedAsPlainText>true</isViewedAsPlainText>
        <text>A Service Territory Membership update is required for {!ServiceResourceRecord.Name} ({!ServiceResourceRecord.FSM_ExternalId__c}). Please create a new service territory membership for this engineer with the below details, and mark complete once actioned. Please note that Primary Territory Memberships cannot overlap.

Effective Date of Change: {!ServiceResourceRecord.FSM_STMEffectiveDate__c}
Work Centre: {!Get_stm_teritorry.Name}
Start of Work Location: {!ServiceResourceRecord.FSM_BaseLocation__c}
Address: City - {!ServiceResourceRecord.FSM_City__c}, Post Code - {!ServiceResourceRecord.FSM_PostCode__c}, 
Country : {!ServiceResourceRecord.FSM_Country__c}, County - {!ServiceResourceRecord.FSM_County__c}, 
Street - {!ServiceResourceRecord.FSM_Street__c}</text>
    </textTemplates>
    <variables>
        <name>CheckAddressisupdated</name>
        <dataType>Boolean</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>CheckEndDateisUpdated</name>
        <dataType>Boolean</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <description>SFI-683</description>
        <name>City</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <description>SFI-683</description>
        <name>Country</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <description>SFI-683</description>
        <name>EffectiveEndDate</name>
        <dataType>DateTime</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <description>SFI-&apos;683</description>
        <name>EffectiveStartDate</name>
        <dataType>DateTime</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <description>SFI-683</description>
        <name>PostCode</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <description>SFI-701</description>
        <name>ServiceResourceRecord</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
        <objectType>ServiceResource</objectType>
    </variables>
    <variables>
        <description>SFi-683</description>
        <name>State</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <description>SFI-683</description>
        <name>Street</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>WCorBUisUpdated</name>
        <dataType>Boolean</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
</Flow>
