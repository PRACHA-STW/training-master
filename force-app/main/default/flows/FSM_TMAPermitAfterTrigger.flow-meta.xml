<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>58.0</apiVersion>
    <areMetricsLoggedToDataCloud>false</areMetricsLoggedToDataCloud>
    <assignments>
        <name>Assign_PE_Values</name>
        <label>Assign PE Values</label>
        <locationX>490</locationX>
        <locationY>839</locationY>
        <assignmentItems>
            <assignToReference>singleRecord.FSM_TMAExternalId__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.FSM_ExternalId__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>singleRecord.FSM_TMAActualEnd__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.FSM_TMAActualEnd__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>singleRecord.FSM_SiteClear__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.FSM_TMASiteClear__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>singleRecord.FSM_ExcavationOccured__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.FSM_ExcavationOccured__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>tma_stop_set</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>assigningValues</name>
        <label>assigningValues</label>
        <locationX>50</locationX>
        <locationY>839</locationY>
        <assignmentItems>
            <assignToReference>singleRecord.FSM_TMAExternalId__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.FSM_ExternalId__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>singleRecord.FSM_TMAActualStart__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.FSM_TMAActualStart__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>if_tma_start_set</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Copy_1_of_assigningValues</name>
        <label>Copy 1 of assigningValues</label>
        <locationX>138</locationX>
        <locationY>1055</locationY>
        <assignmentItems>
            <assignToReference>$Record.FSM_EventType__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>0400</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>get_workorder_record</targetReference>
        </connector>
    </assignments>
    <assignments>
        <description>SFI-1614</description>
        <name>Event_type_assignment</name>
        <label>Event type assignment</label>
        <locationX>446</locationX>
        <locationY>1739</locationY>
        <assignmentItems>
            <assignToReference>singleRecord.FSM_EventType__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.FSM_EventType__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>singleRecord.FSM_ScheduledStartDate__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.FSM_ScheduledStartDate__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>singleRecord.FSM_SiteClear__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.FSM_TMASiteClear__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>singleRecord.FSM_ExcavationOccured__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.FSM_ExcavationOccured__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>singleRecord.FSM_OrderNumber__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>WoOrderNumber</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>singleRecord.FSM_OperationNumber__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>WoOperationNumber</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Get_user_sap_id</targetReference>
        </connector>
    </assignments>
    <assignments>
        <description>SFI-1788
Updated as part of SFI-2256</description>
        <name>notice_state_assigning</name>
        <label>notice state assigning</label>
        <locationX>314</locationX>
        <locationY>1547</locationY>
        <assignmentItems>
            <assignToReference>singleRecord.FSM_NoticeState__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>get_workorder_record.FSM_NoticeState__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Event_type_assignment</targetReference>
        </connector>
    </assignments>
    <assignments>
        <description>SFI-1614</description>
        <name>SAP_User_Id_Assignment</name>
        <label>SAP User Id Assignment</label>
        <locationX>314</locationX>
        <locationY>2063</locationY>
        <assignmentItems>
            <assignToReference>singleRecord.FSM_SAPUserID__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Get_user_sap_id.FSM_ExternalId__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Call_Platform_event_creation_Subflow</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>set_event_type</name>
        <label>set event type</label>
        <locationX>578</locationX>
        <locationY>1055</locationY>
        <assignmentItems>
            <assignToReference>$Record.FSM_EventType__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>0600</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>get_workorder_record</targetReference>
        </connector>
    </assignments>
    <decisions>
        <description>sfi-1724</description>
        <name>if_record_found</name>
        <label>if record found</label>
        <locationX>446</locationX>
        <locationY>1955</locationY>
        <defaultConnector>
            <targetReference>Call_Platform_event_creation_Subflow</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>found</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_user_sap_id</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>SAP_User_Id_Assignment</targetReference>
            </connector>
            <label>found</label>
        </rules>
    </decisions>
    <decisions>
        <name>if_tma_start_set</name>
        <label>if tma start set ?</label>
        <locationX>50</locationX>
        <locationY>947</locationY>
        <defaultConnector>
            <targetReference>Copy_1_of_assigningValues</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>tma_set</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.FSM_EventType__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>0400</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>get_workorder_record</targetReference>
            </connector>
            <label>tma set</label>
        </rules>
    </decisions>
    <decisions>
        <description>sfi-1788</description>
        <name>if_wo_record_found</name>
        <label>if wo record found</label>
        <locationX>446</locationX>
        <locationY>1439</locationY>
        <defaultConnector>
            <targetReference>Event_type_assignment</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>workorder_found</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>get_workorder_record</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>notice_state_assigning</targetReference>
            </connector>
            <label>workorder found</label>
        </rules>
    </decisions>
    <decisions>
        <name>Is_Changed_TMAApproval_Status</name>
        <label>Is Changed TMAApproval Status</label>
        <locationX>446</locationX>
        <locationY>323</locationY>
        <defaultConnector>
            <targetReference>Metadata_records</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>IsChanged</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.FSM_TMAApprovalStatus__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_gantt</targetReference>
            </connector>
            <label>IsChanged</label>
        </rules>
    </decisions>
    <decisions>
        <description>SFS-6663
Updated as part of SFS-8285</description>
        <name>T</name>
        <label>Latest Or Earliest Date changed</label>
        <locationX>446</locationX>
        <locationY>2363</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Changed</name>
            <conditionLogic>1 AND ((2 AND 5) OR (3 AND 7) OR (4 AND 6))</conditionLogic>
            <conditions>
                <leftValueReference>ISNEW</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.FSM_PermitStartDate__c</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <elementReference>$Record__Prior.FSM_PermitStartDate__c</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.FSM_LatestStartDate__c</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <elementReference>$Record__Prior.FSM_LatestStartDate__c</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.FSM_PermitEndDate__c</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <elementReference>$Record__Prior.FSM_PermitEndDate__c</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.FSM_PermitStartDate__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.FSM_PermitEndDate__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.FSM_LatestStartDate__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_icon</targetReference>
            </connector>
            <label>Changed</label>
        </rules>
    </decisions>
    <decisions>
        <name>tma_stop_set</name>
        <label>tma stop set ?</label>
        <locationX>490</locationX>
        <locationY>947</locationY>
        <defaultConnector>
            <targetReference>set_event_type</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Copy_1_of_tma_set</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.FSM_EventType__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>0600</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>get_workorder_record</targetReference>
            </connector>
            <label>Copy 1 of tma set</label>
        </rules>
    </decisions>
    <decisions>
        <name>TMAPE_Notification</name>
        <label>TMA PE Notification</label>
        <locationX>446</locationX>
        <locationY>731</locationY>
        <defaultConnector>
            <isGoTo>true</isGoTo>
            <targetReference>T</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>TMAStartDate_Changed</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record__Prior.FSM_TMAActualStart__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.FSM_TMAActualStart__c</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <elementReference>$Record__Prior.FSM_TMAActualStart__c</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Metadata_records</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>assigningValues</targetReference>
            </connector>
            <label>TMA StartDate Changed</label>
        </rules>
        <rules>
            <name>TMA_StopDate_Changed</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record__Prior.FSM_TMAActualEnd__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.FSM_TMAActualEnd__c</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <elementReference>$Record__Prior.FSM_TMAActualEnd__c</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Metadata_records</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_PE_Values</targetReference>
            </connector>
            <label>TMA StopDate Changed</label>
        </rules>
    </decisions>
    <description>SFS-1464
SFI-692
SFI-707 
SFI-705
SFI-1127
Updated as  a part of SFI-1614
Updated as  a part of SFI-1724
Updated as  a part of SFI-1788
Updated as  a part of SFI-2256
Updated as  a part of SFI-2861.
Updated as  a part of SFI-2892
Updated as  a part of SFS-8285
modified  as  a part of SFS-8421
Updated as  a part of SFS-8232</description>
    <environments>Default</environments>
    <formulas>
        <description>SFS-1464</description>
        <name>ISNEW</name>
        <dataType>Boolean</dataType>
        <expression>ISNEW()</expression>
    </formulas>
    <formulas>
        <description>sfi-2861</description>
        <name>WoOperationNumber</name>
        <dataType>String</dataType>
        <expression>IF(!ISBLANK({!get_workorder_record.FSM_OperationNumber__c}),{!get_workorder_record.FSM_OperationNumber__c} , null)</expression>
    </formulas>
    <formulas>
        <description>sfi-2861</description>
        <name>WoOrderNumber</name>
        <dataType>String</dataType>
        <expression>IF(!ISBLANK({!get_workorder_record.FSM_OrderNumber__c}),{!get_workorder_record.FSM_OrderNumber__c} , null)</expression>
    </formulas>
    <interviewLabel>FSM TMAPermit AfterUpdate {!$Flow.CurrentDateTime}</interviewLabel>
    <label>FSM TMAPermit AfterTrigger</label>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordLookups>
        <description>sfi-1724</description>
        <name>Get_user_sap_id</name>
        <label>Get user sap id</label>
        <locationX>446</locationX>
        <locationY>1847</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>if_record_found</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.LastModifiedById</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>User</object>
        <queriedFields>Id</queriedFields>
        <queriedFields>FSM_ExternalId__c</queriedFields>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <description>sfi-1788</description>
        <name>get_workorder_record</name>
        <label>get workorder record</label>
        <locationX>446</locationX>
        <locationY>1331</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>if_wo_record_found</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.FSM_WorkOrderRefID__c</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>WorkOrder</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Metadata_records</name>
        <label>Metadata records</label>
        <locationX>446</locationX>
        <locationY>623</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>TMAPE_Notification</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>FSM_InterfaceAPIName__c</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>FSM_SendTMAUpdates__e</stringValue>
            </value>
        </filters>
        <filters>
            <field>Active__c</field>
            <operator>EqualTo</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>FSM_InterfaceToggle__mdt</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <start>
        <locationX>320</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>Is_Changed_TMAApproval_Status</targetReference>
        </connector>
        <object>FSM_TMAPermit__c</object>
        <recordTriggerType>CreateAndUpdate</recordTriggerType>
        <triggerType>RecordAfterSave</triggerType>
    </start>
    <status>Active</status>
    <subflows>
        <description>SFI-1208</description>
        <name>Call_Platform_event_creation_Subflow</name>
        <label>Call Platform event creation Subflow</label>
        <locationX>446</locationX>
        <locationY>2255</locationY>
        <connector>
            <targetReference>T</targetReference>
        </connector>
        <flowName>FSM_TMASubflowCreatePlatformEventRecord</flowName>
        <inputAssignments>
            <name>singleRecord</name>
            <value>
                <elementReference>singleRecord</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>triggeredTMA</name>
            <value>
                <elementReference>$Record</elementReference>
            </value>
        </inputAssignments>
    </subflows>
    <subflows>
        <description>SFS-1464</description>
        <name>Update_gantt</name>
        <label>Update gantt</label>
        <locationX>314</locationX>
        <locationY>431</locationY>
        <connector>
            <targetReference>Metadata_records</targetReference>
        </connector>
        <flowName>FSM_ServiceAppointmentGantticonupdate</flowName>
        <inputAssignments>
            <name>TMAID</name>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>TMAStatus</name>
            <value>
                <elementReference>$Record.FSM_TMAApprovalStatus__c</elementReference>
            </value>
        </inputAssignments>
    </subflows>
    <subflows>
        <description>SFS-6663</description>
        <name>Update_icon</name>
        <label>Update icon</label>
        <locationX>314</locationX>
        <locationY>2471</locationY>
        <flowName>FSM_ServiceAppointmentTMASubFlowUpdateGant_Icon</flowName>
        <inputAssignments>
            <name>TMAPermitID</name>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </inputAssignments>
    </subflows>
    <variables>
        <name>singleRecord</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>true</isOutput>
        <objectType>FSM_SendTMAUpdates__e</objectType>
    </variables>
    <variables>
        <description>SFS-1464, this will hold all work order ids</description>
        <name>WorkOrderIds</name>
        <dataType>String</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
</Flow>
