<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>63.0</apiVersion>
    <areMetricsLoggedToDataCloud>false</areMetricsLoggedToDataCloud>
    <assignments>
        <name>Assign_to_collection</name>
        <label>Assign to collection</label>
        <locationX>743</locationX>
        <locationY>827</locationY>
        <assignmentItems>
            <assignToReference>SCAbsenceIdCollection</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>resourceabsencesloop.Id</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>resourceabsencesloop</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>check_if_to_be_deleted_records_are_null_or_not</name>
        <label>Check if to be deleted records are null or not</label>
        <locationX>479</locationX>
        <locationY>1103</locationY>
        <defaultConnector>
            <targetReference>Check_if_user_have_FSM_CrewMemberCREDPermission_permission</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>not_null</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>SCAbsenceIdCollection</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_Crew_Absence_records_to_delete</targetReference>
            </connector>
            <label>not null</label>
        </rules>
    </decisions>
    <decisions>
        <description>SFL-885, to check if the user is a Scheduler, Business Admin, Contractor Scheduler, Tech Admin, System Admin</description>
        <name>Check_if_user_have_FSM_CrewMemberCREDPermission_permission</name>
        <label>Check if user have FSM_CrewMemberCREDPermission permission</label>
        <locationX>644</locationX>
        <locationY>1787</locationY>
        <defaultConnectorLabel>Don&apos;t have permission</defaultConnectorLabel>
        <rules>
            <name>Have_permission</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Permission.FSM_CrewMemberCREDPermission</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Fetch_ServResCrew</targetReference>
            </connector>
            <label>Have permission</label>
        </rules>
    </decisions>
    <decisions>
        <description>//Added by Anup as part of SFL-1091 fix.
//To check if the collection is null before the deletion to prevent execution error.</description>
        <name>Crew_Absence_null_check_before_deletion</name>
        <label>Crew Absence null check before deletion</label>
        <locationX>325</locationX>
        <locationY>1319</locationY>
        <defaultConnector>
            <targetReference>Check_if_user_have_FSM_CrewMemberCREDPermission_permission</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>No Absence record on crew</defaultConnectorLabel>
        <rules>
            <name>Absence_present_on_crew</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Collection_CrewAbsencesToDelete</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Delete_SC_Absences</targetReference>
            </connector>
            <label>Absence present on crew</label>
        </rules>
    </decisions>
    <decisions>
        <name>Decision_3</name>
        <label>Membership matching SR absence</label>
        <locationX>655</locationX>
        <locationY>719</locationY>
        <defaultConnector>
            <targetReference>Assign_to_collection</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Delete Child Absence</defaultConnectorLabel>
        <rules>
            <name>Outcome_1_of_Decision_3</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_Memerbship_for_Abs_duration</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>resourceabsencesloop</targetReference>
            </connector>
            <label>Outcome 1 of Decision 3</label>
        </rules>
    </decisions>
    <decisions>
        <description>SFL-885</description>
        <name>Delete_assigned_resource_on_SCM_delete</name>
        <label>Delete assigned resource on SCM delete</label>
        <locationX>182</locationX>
        <locationY>2111</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Delete_assigned_resource</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Fetch_appointment_for_ServResCrew.Id</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Call_FSM_CrewMemberBasedSASearch_on_delete</targetReference>
            </connector>
            <label>Delete assigned resource</label>
        </rules>
    </decisions>
    <decisions>
        <name>recordsFound</name>
        <label>recordsFound</label>
        <locationX>644</locationX>
        <locationY>395</locationY>
        <defaultConnector>
            <targetReference>Check_if_user_have_FSM_CrewMemberCREDPermission_permission</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>absencePresent</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>getAbsences</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>resourceabsencesloop</targetReference>
            </connector>
            <label>absencePresent</label>
        </rules>
    </decisions>
    <description>Updated as part of SFL-885, to remove crew members from service appointments when SCM is deleted
Updated as a part of SFL-1091</description>
    <environments>Default</environments>
    <interviewLabel>FSM_serviceCrewMember_afterDelete {!$Flow.CurrentDateTime}</interviewLabel>
    <label>FSM_serviceCrewMember_afterDelete</label>
    <loops>
        <name>resourceabsencesloop</name>
        <label>resourceabsencesloop</label>
        <locationX>479</locationX>
        <locationY>503</locationY>
        <collectionReference>getAbsences</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Get_Memerbship_for_Abs_duration</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>check_if_to_be_deleted_records_are_null_or_not</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordDeletes>
        <name>Delete_SC_Absences</name>
        <label>Delete SC Absences</label>
        <locationX>193</locationX>
        <locationY>1427</locationY>
        <connector>
            <targetReference>Check_if_user_have_FSM_CrewMemberCREDPermission_permission</targetReference>
        </connector>
        <inputReference>Collection_CrewAbsencesToDelete</inputReference>
    </recordDeletes>
    <recordLookups>
        <description>SFL-885</description>
        <name>Fetch_appointment_for_ServResCrew</name>
        <label>Fetch appointment for ServResCrew</label>
        <locationX>182</locationX>
        <locationY>2003</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Delete_assigned_resource_on_SCM_delete</targetReference>
        </connector>
        <faultConnector>
            <targetReference>Create_ErrorLog</targetReference>
        </faultConnector>
        <filterLogic>1 AND (2 OR 3 OR 4 OR 5 OR 6 OR 7)</filterLogic>
        <filters>
            <field>FSSK__FSK_Assigned_Service_Resource__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Fetch_ServResCrew.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>Status</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Scheduled</stringValue>
            </value>
        </filters>
        <filters>
            <field>Status</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Dispatched</stringValue>
            </value>
        </filters>
        <filters>
            <field>Status</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>En-Route</stringValue>
            </value>
        </filters>
        <filters>
            <field>Status</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Onsite</stringValue>
            </value>
        </filters>
        <filters>
            <field>Status</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>On Hold</stringValue>
            </value>
        </filters>
        <filters>
            <field>Status</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Return to Site</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>ServiceAppointment</object>
        <queriedFields>Id</queriedFields>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <description>SFL-885</description>
        <name>Fetch_ServResCrew</name>
        <label>Fetch ServResCrew</label>
        <locationX>182</locationX>
        <locationY>1895</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Fetch_appointment_for_ServResCrew</targetReference>
        </connector>
        <faultConnector>
            <isGoTo>true</isGoTo>
            <targetReference>Create_ErrorLog</targetReference>
        </faultConnector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>ServiceCrewId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.ServiceCrew.Id</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>ServiceResource</object>
        <queriedFields>Id</queriedFields>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <description>//Added by Anup as part of SFL-1091 fix.
//To fetch all crew related absence records for deletion into a collection.</description>
        <name>Get_Crew_Absence_records_to_delete</name>
        <label>Get Crew Absence records to delete</label>
        <locationX>325</locationX>
        <locationY>1211</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Crew_Absence_null_check_before_deletion</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>FSM_ServiceResourceAbsence__c</field>
            <operator>In</operator>
            <value>
                <elementReference>SCAbsenceIdCollection</elementReference>
            </value>
        </filters>
        <object>ResourceAbsence</object>
        <outputReference>Collection_CrewAbsencesToDelete</outputReference>
        <queriedFields>Id</queriedFields>
    </recordLookups>
    <recordLookups>
        <description>Get other crew membership for absence duration if exist</description>
        <name>Get_Memerbship_for_Abs_duration</name>
        <label>Get Memerbship for Abs duration</label>
        <locationX>655</locationX>
        <locationY>611</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Decision_3</targetReference>
        </connector>
        <filterLogic>1 AND 2 AND (  (3 AND 4) OR ( 5 AND 7 AND 4) OR (3 AND 8 AND 6 )  OR (5 AND 6) )</filterLogic>
        <filters>
            <field>ServiceResourceId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.ServiceResourceId</elementReference>
            </value>
        </filters>
        <filters>
            <field>Id</field>
            <operator>NotEqualTo</operator>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>StartDate</field>
            <operator>GreaterThanOrEqualTo</operator>
            <value>
                <elementReference>resourceabsencesloop.Start</elementReference>
            </value>
        </filters>
        <filters>
            <field>EndDate</field>
            <operator>LessThanOrEqualTo</operator>
            <value>
                <elementReference>resourceabsencesloop.End</elementReference>
            </value>
        </filters>
        <filters>
            <field>StartDate</field>
            <operator>LessThanOrEqualTo</operator>
            <value>
                <elementReference>resourceabsencesloop.Start</elementReference>
            </value>
        </filters>
        <filters>
            <field>EndDate</field>
            <operator>GreaterThanOrEqualTo</operator>
            <value>
                <elementReference>resourceabsencesloop.End</elementReference>
            </value>
        </filters>
        <filters>
            <field>EndDate</field>
            <operator>GreaterThanOrEqualTo</operator>
            <value>
                <elementReference>resourceabsencesloop.Start</elementReference>
            </value>
        </filters>
        <filters>
            <field>StartDate</field>
            <operator>LessThanOrEqualTo</operator>
            <value>
                <elementReference>resourceabsencesloop.End</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>ServiceCrewMember</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>getAbsences</name>
        <label>getAbsences</label>
        <locationX>644</locationX>
        <locationY>287</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>recordsFound</targetReference>
        </connector>
        <filterLogic>1 AND 2 AND (  (3 AND 4) OR ( 5 AND 7 AND 4) OR (3 AND 8 AND 6 )  OR (5 AND 6) ) AND 9</filterLogic>
        <filters>
            <field>ResourceId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.ServiceResource.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>FSM_ServiceResourceAbsence__c</field>
            <operator>IsNull</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <filters>
            <field>Start</field>
            <operator>GreaterThanOrEqualTo</operator>
            <value>
                <elementReference>$Record.StartDate</elementReference>
            </value>
        </filters>
        <filters>
            <field>End</field>
            <operator>LessThanOrEqualTo</operator>
            <value>
                <elementReference>$Record.EndDate</elementReference>
            </value>
        </filters>
        <filters>
            <field>Start</field>
            <operator>LessThanOrEqualTo</operator>
            <value>
                <elementReference>$Record.StartDate</elementReference>
            </value>
        </filters>
        <filters>
            <field>End</field>
            <operator>GreaterThanOrEqualTo</operator>
            <value>
                <elementReference>$Record.EndDate</elementReference>
            </value>
        </filters>
        <filters>
            <field>End</field>
            <operator>GreaterThanOrEqualTo</operator>
            <value>
                <elementReference>$Record.StartDate</elementReference>
            </value>
        </filters>
        <filters>
            <field>Start</field>
            <operator>LessThanOrEqualTo</operator>
            <value>
                <elementReference>$Record.EndDate</elementReference>
            </value>
        </filters>
        <filters>
            <field>Type</field>
            <operator>NotEqualTo</operator>
            <value>
                <stringValue>Break</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>ResourceAbsence</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <start>
        <locationX>518</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>getAbsences</targetReference>
        </connector>
        <object>ServiceCrewMember</object>
        <recordTriggerType>Delete</recordTriggerType>
        <triggerType>RecordBeforeDelete</triggerType>
    </start>
    <status>Active</status>
    <subflows>
        <description>SFL-885</description>
        <name>Call_FSM_CrewMemberBasedSASearch_on_delete</name>
        <label>Call FSM_CrewMemberBasedSASearch on delete</label>
        <locationX>50</locationX>
        <locationY>2219</locationY>
        <flowName>FSM_CrewMemberBasedSASearch</flowName>
        <inputAssignments>
            <name>SCM_Record</name>
            <value>
                <elementReference>$Record</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>ServResCrew</name>
            <value>
                <elementReference>Fetch_ServResCrew.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>triggeredFor</name>
            <value>
                <stringValue>Delete</stringValue>
            </value>
        </inputAssignments>
    </subflows>
    <subflows>
        <description>SFL-885</description>
        <name>Create_ErrorLog</name>
        <label>Create ErrorLog</label>
        <locationX>578</locationX>
        <locationY>2111</locationY>
        <flowName>ErrorLog_Subflow_Create_Record</flowName>
        <inputAssignments>
            <name>ErrorType</name>
            <value>
                <stringValue>Exception</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>FSM_ExternalId</name>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>FSM_FaultMessage</name>
            <value>
                <elementReference>$Flow.FaultMessage</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>FSM_FlowName</name>
            <value>
                <elementReference>$Flow.CurrentRecord</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>FSM_Type</name>
            <value>
                <stringValue>Field Service</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>Interface</name>
            <value>
                <stringValue>INT-003</stringValue>
            </value>
        </inputAssignments>
    </subflows>
    <variables>
        <description>//Added by Anup as part of 1091 fix.
//Holds all Crew absence records of resource which are deleted from the crew.</description>
        <name>Collection_CrewAbsencesToDelete</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>ResourceAbsence</objectType>
    </variables>
    <variables>
        <name>collectionOfAbsences</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>ResourceAbsence</objectType>
    </variables>
    <variables>
        <name>RAtobeDelink</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>ResourceAbsence</objectType>
    </variables>
    <variables>
        <name>SCAbsenceIdCollection</name>
        <dataType>String</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
</Flow>
