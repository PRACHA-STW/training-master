<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <areMetricsLoggedToDataCloud>false</areMetricsLoggedToDataCloud>
    <assignments>
        <name>Adjusted_Travel_Time</name>
        <label>Set Adjusted Travel Time</label>
        <locationX>270</locationX>
        <locationY>458</locationY>
        <assignmentItems>
            <assignToReference>varTotalTravelTime</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>thisTimeSheetEntry.FSM_TimeDuration__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>for_Each_Time_Sheet_Entry</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Caclulate_Productive_Time_Delta</name>
        <label>Caclulate Prod. Time Delta</label>
        <locationX>534</locationX>
        <locationY>458</locationY>
        <assignmentItems>
            <assignToReference>varDeltaProductiveTime</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>varAdjustedTime</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>for_Each_Time_Sheet_Entry</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Copy_2_of_FLOOR_Prod_Time</name>
        <label>CEILING(Prod.Time)</label>
        <locationX>314</locationX>
        <locationY>1142</locationY>
        <assignmentItems>
            <assignToReference>varTotalProductiveTime</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>varCeilingProductiveTime</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Travel_Time_0</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Cumulative_Productive_TimePlusDelta</name>
        <label>Cumulative Productive Time + Delta</label>
        <locationX>50</locationX>
        <locationY>842</locationY>
        <assignmentItems>
            <assignToReference>varTotalProductiveTime</assignToReference>
            <operator>Assign</operator>
            <value>
                <numberValue>0.0</numberValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varTotalProductiveTime</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>varServiceAppointment.FSM_CumulativeProductiveTimeInMins__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varTotalProductiveTime</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>varDeltaProductiveTime</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Decimal_Cumulative_Travel_Time_0_5</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>FLOOR_Prod_Time</name>
        <label>FLOOR(Prod.Time)</label>
        <locationX>50</locationX>
        <locationY>1142</locationY>
        <assignmentItems>
            <assignToReference>varTotalProductiveTime</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>varFloorOfProductiveTime</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Travel_Time_0</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>NonProductiveTimeEquals0</name>
        <label>Non Productive Time = 0</label>
        <locationX>50</locationX>
        <locationY>2042</locationY>
        <assignmentItems>
            <assignToReference>varTotalNonProductiveTime</assignToReference>
            <operator>Assign</operator>
            <value>
                <numberValue>0.0</numberValue>
            </value>
        </assignmentItems>
    </assignments>
    <assignments>
        <name>ProductiveTimeEqualsZero</name>
        <label>Productive Time = 0</label>
        <locationX>50</locationX>
        <locationY>1742</locationY>
        <assignmentItems>
            <assignToReference>varTotalProductiveTime</assignToReference>
            <operator>Assign</operator>
            <value>
                <numberValue>0.0</numberValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Non_Productive_Time_0</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Set_Non_Productive_Time</name>
        <label>Set Adjusted Non Productive Time</label>
        <locationX>798</locationX>
        <locationY>458</locationY>
        <assignmentItems>
            <assignToReference>varTotalNonProductiveTime</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>thisTimeSheetEntry.FSM_TimeDuration__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>for_Each_Time_Sheet_Entry</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>TravelTimeEqulsZero</name>
        <label>Travel Time = 0</label>
        <locationX>50</locationX>
        <locationY>1442</locationY>
        <assignmentItems>
            <assignToReference>varTotalTravelTime</assignToReference>
            <operator>Assign</operator>
            <value>
                <numberValue>0.0</numberValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Productive_Time_0</targetReference>
        </connector>
    </assignments>
    <decisions>
        <description>Check Time Type</description>
        <name>Check_Time_Type</name>
        <label>Check Time Type</label>
        <locationX>666</locationX>
        <locationY>350</locationY>
        <defaultConnector>
            <targetReference>for_Each_Time_Sheet_Entry</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Others</defaultConnectorLabel>
        <rules>
            <name>Travel</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>thisTimeSheetEntry.Type</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Travel</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Adjusted_Travel_Time</targetReference>
            </connector>
            <label>Travel</label>
        </rules>
        <rules>
            <name>Productive_Time</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>thisTimeSheetEntry.Type</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Productive</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>thisTimeSheetEntry.FSM_AdjustedTimeDuration__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Caclulate_Productive_Time_Delta</targetReference>
            </connector>
            <label>Productive Time</label>
        </rules>
        <rules>
            <name>Non_Productive</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>thisTimeSheetEntry.Type</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Non Productive</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Set_Non_Productive_Time</targetReference>
            </connector>
            <label>Non-Productive</label>
        </rules>
    </decisions>
    <decisions>
        <name>Cumulative_Productive_Time_null</name>
        <label>Has Cumulative Productive Time ?</label>
        <locationX>182</locationX>
        <locationY>734</locationY>
        <defaultConnector>
            <targetReference>Decimal_Cumulative_Travel_Time_0_5</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Yes_CumulativeProductiveTimeNotNull</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>varServiceAppointment.FSM_CumulativeProductiveTimeInMins__c</leftValueReference>
                <operator>GreaterThan</operator>
                <rightValue>
                    <numberValue>0.0</numberValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Cumulative_Productive_TimePlusDelta</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <description>Apply round function on cumulative travel time to take off decimals.</description>
        <name>Decimal_Cumulative_Travel_Time_0_5</name>
        <label>Decimal(Cumulative Travel Time) &lt; 0.5</label>
        <locationX>182</locationX>
        <locationY>1034</locationY>
        <defaultConnector>
            <targetReference>Copy_2_of_FLOOR_Prod_Time</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>No</defaultConnectorLabel>
        <rules>
            <name>Yes_ApplyFloor</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>varDecimalPart</leftValueReference>
                <operator>LessThan</operator>
                <rightValue>
                    <numberValue>0.5</numberValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>FLOOR_Prod_Time</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <name>Non_Productive_Time_0</name>
        <label>Non Productive Time &lt; 0?</label>
        <locationX>182</locationX>
        <locationY>1934</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Yes_NonProdLessThanZero</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>varTotalNonProductiveTime</leftValueReference>
                <operator>LessThan</operator>
                <rightValue>
                    <numberValue>0.0</numberValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>varTotalNonProductiveTime</leftValueReference>
                <operator>EqualTo</operator>
            </conditions>
            <conditions>
                <leftValueReference>varTotalNonProductiveTime</leftValueReference>
                <operator>IsBlank</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>varTotalNonProductiveTime</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>NonProductiveTimeEquals0</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <name>Productive_Time_0</name>
        <label>Productive Time &lt; 0?</label>
        <locationX>182</locationX>
        <locationY>1634</locationY>
        <defaultConnector>
            <targetReference>Non_Productive_Time_0</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Yes_ProductiveTimeLessThanZero</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>varTotalProductiveTime</leftValueReference>
                <operator>LessThan</operator>
                <rightValue>
                    <numberValue>0.0</numberValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>varTotalProductiveTime</leftValueReference>
                <operator>EqualTo</operator>
            </conditions>
            <conditions>
                <leftValueReference>varTotalProductiveTime</leftValueReference>
                <operator>IsBlank</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>varTotalProductiveTime</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>ProductiveTimeEqualsZero</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <name>Travel_Time_0</name>
        <label>Travel Time &lt; 0?</label>
        <locationX>182</locationX>
        <locationY>1334</locationY>
        <defaultConnector>
            <targetReference>Productive_Time_0</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Yes_TravelTimeLTZero</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>varTotalTravelTime</leftValueReference>
                <operator>LessThan</operator>
                <rightValue>
                    <numberValue>0.0</numberValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>varTotalTravelTime</leftValueReference>
                <operator>EqualTo</operator>
            </conditions>
            <connector>
                <targetReference>TravelTimeEqulsZero</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <description>Created as part of SFS-7550.

The flow Calculates Time to Show on the Final Submission Screen. This flow adds the adjusted time (delta only) to the cumulative times on the service appointment for Travel, Productive and Non-Productive Times

Updated to sum up FSM_TimeDuration__c for Travel and Non-Productive Time

Floor and Ceiling applied to Poductive Time to remove decimals</description>
    <environments>Default</environments>
    <formulas>
        <description>Delta Time</description>
        <name>varAdjustedTime</name>
        <dataType>Number</dataType>
        <expression>{!thisTimeSheetEntry.FSM_TimeDuration__c} - {!thisTimeSheetEntry.DurationInMinutes}</expression>
        <scale>0</scale>
    </formulas>
    <formulas>
        <name>varCeilingProductiveTime</name>
        <dataType>Number</dataType>
        <expression>CEILING({!varTotalProductiveTime})</expression>
        <scale>2</scale>
    </formulas>
    <formulas>
        <description>Decimal part of the Productive Travel Tie</description>
        <name>varDecimalPart</name>
        <dataType>Number</dataType>
        <expression>{!varTotalProductiveTime} - FLOOR({!varTotalProductiveTime})</expression>
        <scale>4</scale>
    </formulas>
    <formulas>
        <name>varFloorOfProductiveTime</name>
        <dataType>Number</dataType>
        <expression>FLOOR({!varTotalProductiveTime})</expression>
        <scale>0</scale>
    </formulas>
    <interviewLabel>FSM Calculate Time to Show {!$Flow.CurrentDateTime}</interviewLabel>
    <label>FSM Calculate Time to Show</label>
    <loops>
        <name>for_Each_Time_Sheet_Entry</name>
        <label>for Each Time Sheet Entry</label>
        <locationX>182</locationX>
        <locationY>242</locationY>
        <assignNextValueToReference>thisTimeSheetEntry</assignNextValueToReference>
        <collectionReference>varTimeSheetEntries</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Check_Time_Type</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Cumulative_Productive_Time_null</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>FieldServiceMobile</processType>
    <recordLookups>
        <description>Get Time Sheet Entries</description>
        <name>Get_Time_Sheet_Entries</name>
        <label>Get Time Sheet Entries</label>
        <locationX>182</locationX>
        <locationY>134</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>for_Each_Time_Sheet_Entry</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>FSM_ServiceAppointmentId__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>varServiceAppointment.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>Type</field>
            <operator>IsNull</operator>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </filters>
        <object>TimeSheetEntry</object>
        <outputReference>varTimeSheetEntries</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>Type</queriedFields>
        <queriedFields>FSM_TimeDuration__c</queriedFields>
        <queriedFields>FSM_AdjustedTimeDuration__c</queriedFields>
        <queriedFields>DurationInMinutes</queriedFields>
    </recordLookups>
    <start>
        <locationX>56</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>Get_Time_Sheet_Entries</targetReference>
        </connector>
    </start>
    <status>Active</status>
    <variables>
        <description>Timesheet record in loop</description>
        <name>thisTimeSheetEntry</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>TimeSheetEntry</objectType>
    </variables>
    <variables>
        <description>From a timesheet record, adjusted time is the relevant time to consider. If not present, take the non-adjusted time captured.</description>
        <name>varActualTime</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>2</scale>
        <value>
            <numberValue>0.0</numberValue>
        </value>
    </variables>
    <variables>
        <name>varDeltaNonProductiveTime</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>0</scale>
        <value>
            <numberValue>0.0</numberValue>
        </value>
    </variables>
    <variables>
        <name>varDeltaProductiveTime</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>0</scale>
        <value>
            <numberValue>0.0</numberValue>
        </value>
    </variables>
    <variables>
        <description>Travel Time to add to/subtract from the cumulative time</description>
        <name>varDeltaTravelTime</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>0</scale>
        <value>
            <numberValue>0.0</numberValue>
        </value>
    </variables>
    <variables>
        <description>Service Appointment record in context</description>
        <name>varServiceAppointment</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
        <objectType>ServiceAppointment</objectType>
    </variables>
    <variables>
        <description>Timesheet records under the SA</description>
        <name>varTimeSheetEntries</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>TimeSheetEntry</objectType>
    </variables>
    <variables>
        <name>varTotalNonProductiveTime</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>true</isOutput>
        <scale>0</scale>
        <value>
            <numberValue>0.0</numberValue>
        </value>
    </variables>
    <variables>
        <name>varTotalProductiveTime</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>true</isOutput>
        <scale>0</scale>
        <value>
            <numberValue>0.0</numberValue>
        </value>
    </variables>
    <variables>
        <name>varTotalTravelTime</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>true</isOutput>
        <scale>0</scale>
        <value>
            <numberValue>0.0</numberValue>
        </value>
    </variables>
</Flow>
